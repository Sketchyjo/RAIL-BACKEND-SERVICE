environment: development
log_level: info

server:
  port: 8081
  host: 0.0.0.0
  read_timeout: 30
  write_timeout: 30
  rate_limit_per_min: 100
  supported_versions: ["v1"]
  default_version: "v1"
  allowed_origins:
    - "http://localhost:3000"
    - "http://localhost:8080"

# Distributed Rate Limiting Configuration
# Uses Redis-backed sliding window algorithm for multi-instance rate limiting
rate_limit:
  enabled: true
  global_limit: 10000          # Global requests per window (all instances combined)
  global_window: 60            # Global window in seconds (1 minute)
  ip_limit: 500                # Requests per IP per window
  ip_window: 60                # IP window in seconds (1 minute)
  user_limit: 200              # Requests per authenticated user per window
  user_window: 60              # User window in seconds (1 minute)
  key_prefix: "ratelimit"      # Redis key prefix for rate limiting
  fail_open: true              # Allow requests if Redis is unavailable (false in production)
  response_headers: true       # Include X-RateLimit headers in responses

  # Endpoint-specific rate limits (overrides user_limit for specific endpoints)
  # Format: endpoint_limits.METHOD:/api/v1/path.limit
  endpoint_limits:
    POST:/api/v1/auth/login:
      limit: 5
      window: 900              # 15 minutes
    POST:/api/v1/auth/register:
      limit: 3
      window: 3600             # 1 hour
    POST:/api/v1/funding/withdraw:
      limit: 10
      window: 3600             # 1 hour
    POST:/api/v1/auth/forgot-password:
      limit: 3
      window: 3600             # 1 hour
    POST:/api/v1/auth/reset-password:
      limit: 5
      window: 3600             # 1 hour
    POST:/api/v1/auth/resend-code:
      limit: 5
      window: 900              # 15 minutes
    GET:/api/v1/portfolio:
      limit: 60
      window: 60               # 1 minute
    GET:/api/v1/balances:
      limit: 60
      window: 60               # 1 minute

database:
  url: "${DATABASE_URL}"
  host: "${DATABASE_HOST}"
  port: 5432
  name: "${DATABASE_NAME}"
  user: "${DATABASE_USER}"
  password: "${DATABASE_PASSWORD}"
  ssl_mode: "${DATABASE_SSL_MODE}"  # PRODUCTION: Use 'require' or 'verify-full'
  max_open_conns: 25
  max_idle_conns: 5
  conn_max_lifetime: 300
  query_timeout: 30
  max_retries: 3
  read_replicas: []

redis:
  # Single node mode (development/staging)
  host: "${REDIS_HOST}"
  port: 6379
  password: ""
  db: 0
  # Cluster mode (production) - requires multiple Redis nodes
  cluster_mode: false
  cluster_addrs: ""  # Comma-separated list: "host1:port1,host2:port2"
  max_retries: 3
  pool_size: 10
  # Connection pool settings for HA
  max_idle_conns: 50
  max_active_conns: 200
  idle_timeout: 300  # 5 minutes
  # Cluster configuration
  route_randomly: true
  route_by_latency: true

jwt:
  # CRITICAL SECURITY WARNING: This secret must be generated securely and never committed to version control
  # Generate with: openssl rand -base64 32
  # Minimum 32 characters required for HMAC-SHA256
  secret: "${JWT_SECRET:-change-this-in-production-insecure-default}"  # MUST BE OVERRIDDEN IN PRODUCTION
  access_token_ttl: 900      # 15 minutes (short-lived for security)
  refresh_token_ttl: 604800  # 7 days
  issuer: "rail_service"

security:
  mfa_grace_period_days: 7
  high_value_threshold: 50000
  geo_api_key: ""
  enable_geo_blocking: true
  enable_vpn_detection: true
  fraud_score_threshold: 0.7
  fraud_review_threshold: 0.5
  incident_alert_webhook: ""
  auto_block_threshold: 20
  # CRITICAL SECURITY WARNING: This key must be exactly 32 bytes for AES-256-GCM encryption
  # Generate with: openssl rand -base64 32 | head -c 32
  # NEVER commit this to version control or use default values in production
  encryption_key: "${ENCRYPTION_KEY:-9foZ22ccMYtiFckFMoLRUdLQzm3bxKeE5eC8dlXOrHDPKGwTOxuEd0jTCTBPCveb}"  # MUST BE OVERRIDDEN IN PRODUCTION
  max_login_attempts: 5
  lockout_duration: 900
  require_mfa: false
  password_min_length: 12  # Changed from 8 to match security requirements
  session_timeout: 3600
  # Enhanced security settings
  bcrypt_cost: 12                    # Increased from default 10 for stronger hashing
  password_history_count: 5          # Prevent reuse of last 5 passwords
  password_expiration_days: 90       # Force password change every 90 days
  access_token_ttl: 900              # 15 minutes (override JWT setting)
  refresh_token_ttl: 604800          # 7 days
  enable_token_blacklist: true       # Enable token revocation via Redis
  check_password_breaches: true      # Check passwords against HaveIBeenPwned
  captcha_threshold: 3               # Require CAPTCHA after 3 failed login attempts
  secrets_provider: "env"            # "env" or "aws_secrets_manager"
  aws_secrets_region: "us-east-1"    # AWS region for Secrets Manager
  aws_secrets_prefix: "rail/"        # Prefix for secret names in AWS
  secret_rotation_days: 90           # Rotate secrets every 90 days

workers:
  count: 10
  job_timeout: 300

circle:
  api_key: ""
  environment: "sandbox"
  base_url: ""
  entity_secret_ciphertext: ""
  default_wallet_set_id: ""
  default_wallet_set_name: "STACK-WalletSet"
  supported_chains: ["SOL-DEVNET"]

kyc:
  provider: ""
  api_key: ""
  api_secret: ""
  base_url: "https://netverify.com"
  callback_url: ""
  environment: "development"
  user_agent: "Stack-Service/1.0"
  level_name: "basic-kyc"

email:
  provider: "mailpit"
  api_key: ""
  from_email: "no-reply@rail.app"
  from_name: "RAIL Service"
  base_url: "http://localhost:3000"
  environment: "development"
  reply_to: ""
  smtp_host: "mailpit"
  smtp_port: 1025
  smtp_username: ""
  smtp_password: ""
  smtp_use_tls: false

sms:
  provider: ""
  api_key: ""
  api_secret: ""
  from_number: ""
  environment: "development"

verification:
  code_length: 6
  code_ttl_minutes: 10
  max_attempts: 3
  rate_limit_per_hour: 3

alpaca:
  client_id: "${ALPACA_API_KEY}"
  secret_key: "${ALPACA_API_SECRET}"
  base_url: "${ALPACA_BASE_URL:-https://broker-api.sandbox.alpaca.markets}"
  data_base_url: "${ALPACA_DATA_BASE_URL:-https://data.sandbox.alpaca.markets}"
  environment: "${ALPACA_ENVIRONMENT:-sandbox}"
  timeout: 30
  auth_method: "oauth2"  # oauth2 or legacy
  # Webhook signature verification secret (generate with: openssl rand -base64 32)
  webhook_secret: "${ALPACA_WEBHOOK_SECRET:-}"

bridge:
  api_key: "${BRIDGE_API_KEY}"
  base_url: "${BRIDGE_BASE_URL:-https://api.sandbox.bridge.xyz}"
  environment: "sandbox"
  timeout: 30
  max_retries: 3
  webhook_secret: "${BRIDGE_WEBHOOK_SECRET}"
  supported_chains:
    - "solana"

  transaction_limits:
  deposit:
    daily: 10000.00
    weekly: 50000.00
    monthly: 200000.00
  withdrawal:
    daily: 5000.00
    weekly: 25000.00
    monthly: 100000.00
  trade:
    daily: 50000.00
    weekly: 250000.00
    monthly: 1000000.00
  transfer:
    daily: 10000.00
    weekly: 50000.00
    monthly: 200000.00
  risk_threshold: 0.9

social_auth:
  google:
    client_id: ""
    client_secret: ""
    redirect_uri: ""
  apple:
    client_id: ""        # Bundle ID or Services ID
    team_id: ""          # Apple Developer Team ID
    key_id: ""           # Key ID from Apple Developer Portal
    private_key: ""      # P8 private key content (base64 encoded)
    redirect_uri: ""

webauthn:
  rp_display_name: "RAIL"
  rp_id: "rail.app"
  rp_origins:
    - "https://rail.app"

ai:
  primary_provider: "openai"  # or "gemini"
  fallback_provider: "gemini"
  openai:
    api_key: "${OPENAI_API_KEY}"
    model: "gpt-3.5-turbo"  # Free tier model
    max_tokens: 1000
    temperature: 0.7
    timeout: 30s
    rate_limit_rpm: 3  # Requests per minute (free tier limit)
  gemini:
    api_key: "${GEMINI_API_KEY}"
    model: "gemini-1.5-flash"  # Free tier model
    max_tokens: 1000
    temperature: 0.7
    timeout: 30s
    rate_limit_rpm: 15  # Requests per minute (free tier limit)
  prompts:
    wrapped_template: "prompts/wrapped.txt"
    chat_template: "prompts/chat.txt"
# News Configuration
news:
  provider: "alpaca"  # or "finnhub"
  api_key: "${NEWS_API_KEY}"
  fetch_interval: "1h"
  articles_per_user: 5
  relevance_threshold: 0.6
# Wrapped Configuration
wrapped:
  schedule: "0 0 * * 0"  # Sunday midnight
  batch_size: 100
  enable_notifications: true
  cards_enabled:
    - performance_headline
    - top_mover
    - personality
    - contributions
    - news
    - suggestion
# Chat Configuration
chat:
  max_context_messages: 10
  session_timeout: "24h"
  enable_safety_filter: true
  rate_limit_per_hour: 50
